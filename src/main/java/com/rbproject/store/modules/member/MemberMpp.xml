<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rbproject.store.modules.member.MemberMpp">

    <resultMap id="resultMapObj" type="com.rbproject.store.modules.member.Member"></resultMap>
    
    <sql id="selectCommon">
    	from infrMember a
			left join infrMemberAddress b on b.ifmaDelNy = 0 and b.ifmaDefaultNy = 1 and b.ifmmSeq = a.ifmmSeq
		    left join infrMemberNationality g on g.ifmnDefaultNy = 1 and g.ifmnDelNy = 0 and g.ifmmSeq = a.ifmmSeq
		    left join infrmemberphone h on h.ifmpDelNy = 0 and h.ifmpDefaultNy = 1 and h.ifmmSeq = a.ifmmSeq and h.ifmpDeviceCd = 25 and h.ifmpDefaultNy = 1
		where 1=1
			and a.ifmmDelNy = 0
			<choose>
				<when test="shOption == 1">AND a.ifmmName LIKE concat('%',#{shValue},'%')</when>
				<when test="shOption == 2">AND a.ifmmId LIKE concat('%',#{shValue},'%')</when>
				<when test="shOption == 3">AND concat(b.ifmaAddress1," ",b.ifmaAddress2) LIKE concat('%',#{shValue},'%')</when>
				<when test="shOption == 4">AND h.ifmpNumber LIKE concat('%',#{shValue},'%')</when>
			</choose>
    </sql>
    
    
    <select id="selectOneCount" resultType="Integer">
    	SELECT
			count(*)
		<include refid="selectCommon" />
    </select>

	<select id="selectList" resultMap="resultMapObj">
		select
			a.ifmmseq
		    , a.ifmmName
		    , a.ifmmId
		    , concat("[",b.ifmaZipcode,"] ",b.ifmaAddress1," ",b.ifmaAddress2) as ifmaAddress
		    , (select concat(substring(ifmpNumber,1,3),"-",substring(ifmpNumber,4,4),"-",substring(ifmpNumber,7,4)) from infrmemberphone where ifmpDeviceCd = 25 and ifmpDefaultNy = 1 and a.ifmmSeq = ifmmSeq) as ifmpNumberDash
		    , (select ifnaName from infrNationality where ifnaSeq = g.ifnaSeq) as ifnaName
		    , h.ifmpNumber
		 <include refid="selectCommon" />
		 limit #{startRnumForMysql}, #{rowNumToShow}
	</select>
	
	<select id="selectOne" resultMap="resultMapObj">
			select
				a.ifmmseq
			    , a.ifmmName
			    , a.ifmmId
			    , (select ifcdName from infrCode where a.ifmmGenderCd = ifcdSeq) as ifmmGender
			    , a.ifmmDob
			    , (select ifcdName from infrCode where a.ifmmSavedCd = ifcdSeq) as ifmmSaved
			    , (select ifcdName from infrCode where a.ifmmMarriageCd = ifcdSeq) as ifmmMarriage
			    , a.ifmmMarriageDate
			    , a.ifmmChildrenNum
			    , a.ifmmFavoriteColor
			    , a.ifmmEmailConsentNy
			    , a.ifmmSmsConsentNy
			    , a.ifmmPushConsentNy
			    , concat("[",b.ifmaZipcode,"] ",b.ifmaAddress1," ",b.ifmaAddress2) as ifmaAddress
			    , ifnull((select ifcdName from infrCode where c.ifaoSnsTypeCd = ifcdSeq),"-") as ifmmSns
			    , ifnull(c.ifaoUrl,"-") as ifaoUrl
			    , d.ifmeEmailFull
			    , (select ifcdName from infrCode where f.ifjqQuestionCd = ifcdSeq) as ifjqQuestion
			    , f.ifjqAnswer
			    , (select ifcdName from infrCode where h.ifmpTelecomCd = ifcdSeq) as ifmpTelecom
			    , h.ifmpNumber
			    , concat(substring(ifmpNumber,1,3),"-",substring(ifmpNumber,4,4),"-",substring(ifmpNumber,7,4)) as ifmpNumberDash
			    , (select concat(substring(ifmpNumber,1,2),"-",substring(ifmpNumber,3,3),"-",substring(ifmpNumber,6,4)) from infrmemberphone where ifmpDeviceCd = 24 and ifmpDefaultNy = 1 and ifmmSeq=a.ifmmSeq) as ifmpHomeNumber
			    , (select concat(substring(ifmpNumber,1,3),"-",substring(ifmpNumber,4,3),"-",substring(ifmpNumber,7,4)) from infrmemberphone where ifmpDeviceCd = 26 and ifmpDefaultNy = 1 and ifmmSeq=a.ifmmSeq) as ifmpFaxNumber
			    , (select ifnaName from infrNationality where ifnaSeq = g.ifnaSeq) as ifnaName
			    
			from infrMember a
				left join infrMemberAddress b on b.ifmaDelNy = 0 and b.ifmaDefaultNy = 1 and b.ifmmSeq = a.ifmmSeq
			    left join infrMemberAddressOnline c on c.ifaoDelNy = 0 and c.ifaoDefaultNy = 1 and c.ifmmSeq = a.ifmmSeq
			    left join infrMembereMail d on d.ifmeDelNy = 0 and d.ifmeDefaultNy = 1 and d.ifmmSeq = a.ifmmSeq
			    -- left join infrMemberHobby e on e.ifmhDelNy = 0 and e.ifmhDefaultNy = 1 and e.ifmmSeq = a.ifmmSeq
			    left join infrMemberJoinQna f on f.ifjqDelNy = 0 and f.ifmmSeq = a.ifmmSeq
			    left join infrMemberNationality g on g.ifmnDefaultNy = 1 and g.ifmnDelNy = 0 and g.ifmmSeq = a.ifmmSeq
			    left join infrmemberphone h on h.ifmpDelNy = 0 and h.ifmpDefaultNy = 1 and h.ifmmSeq = a.ifmmSeq and h.ifmpDeviceCd = 25 and h.ifmpDefaultNy = 1
			where 1=1
				and a.ifmmDelNy = 0
				AND a.ifmmSeq = #{ifmmSeq}
	</select>
	
	<select id="selectCode" resultMap="resultMapObj">
		SELECT
			ifcdSeq
			,ifcdName
			,ifcgSeq 
		FROM
			infrCode
	</select>
	
	<insert id="insertInfrMember">
		insert into infrMember(
			ifmmId
			,ifmmName
			,ifmmGenderCd
			,ifmmPassword
			,ifmmDob
			,ifmmSmsConsentNy
			,ifmmEmailConsentNy
			,ifmmSavedCd
			,ifmmMarriageCd
			,ifmmMarriageDate
			,ifmmChildrenNum
			,ifmmFavoriteColor
			,ifmmDesc
			,ifmmRecommenderSeq
			,ifmmDelNy
		) values (
			#{ifmmId}
			,#{ifmmName}
			,#{ifmmGenderCd}
			,#{ifmmPassword}
			,#{ifmmDob}
			,#{ifmmSmsConsentNy}
			,#{ifmmEmailConsentNy}
			,#{ifmmSavedCd}
			,#{ifmmMarriageCd}
			,#{ifmmMarriageDate}
			,#{ifmmChildrenNum}
			,#{ifmmFavoriteColor}
			,#{ifmmDesc}
			<if test="ifmmRecommenderName != null and !ifmmRecommenderName.equals('')">,(select a.ifmmSeq from infrMember a where a.ifmmName LIKE #{ifmmRecommenderName})</if>
			,0
		)
		<selectKey resultType="string" keyProperty="ifmmSeq" order="AFTER">
			SELECT last_insert_id()
		</selectKey>
	</insert>
	
	<insert id="insertInfrMemberNationality">
		insert into infrMemberNationality(
			ifmmSeq
			,ifnaSeq
			,ifmnDefaultNy 
			,ifmnDelNy
		) values (
			#{ifmmSeq}
			,#{ifnaSeq}
			,1
			,0
		)
	</insert>
	
	<insert id="insertInfrMemberAddress">
		insert into infrMemberAddress(
			ifmmSeq
			,ifmaZipcode
			,ifmaAddress1
			,ifmaAddress2
			,ifmaDefaultNy
			,ifmaDelNy
		) values (
			#{ifmmSeq}
			,#{ifmaZipcode}
			,#{ifmaAddress1}
			,#{ifmaAddress2}
			,1
			,0
		)
	</insert>
	
	<insert id="insertInfrMemberMobile">
		insert into infrMemberPhone(
			ifmmSeq
			,ifmpTelecomCd
			,ifmpNumber
			,ifmpDeviceCd
			,ifmpDefaultNy
			,ifmpDelNy
		) values (
			#{ifmmSeq}
			,#{ifmpTelecomCd}
			,concat(#{ifmpNumber1},#{ifmpNumber2},#{ifmpNumber3})
			,25
			,1
			,0
		)
	</insert>
	
	<insert id="insertInfrMemberPhone">
		insert into infrMemberPhone(
			ifmmSeq
			,ifmpNumber
			,ifmpDeviceCd
			,ifmpDefaultNy
			,ifmpDelNy
		) values (
			#{ifmmSeq}
			,concat(#{ifmpPhone1},#{ifmpPhone2},#{ifmpPhone3})
			,24
			,1
			,0
		)
	</insert>
	
	<insert id="insertInfrMemberFax">
		insert into infrMemberPhone(
			ifmmSeq
			,ifmpNumber
			,ifmpDeviceCd
			,ifmpDefaultNy
			,ifmpDelNy
		) values ( 
			#{ifmmSeq}
			,concat(#{ifmpFax1},#{ifmpFax2},#{ifmpFax3})
			,26
			,1
			,0
		)
	</insert>
	
	<insert id="insertInfrMemberEmail">
		insert into infrMemberEmail(
			ifmmSeq
			,ifmeEmailAccount
			,ifmeEmailDomainCd
			,ifmeEmailFull
			,ifmeDefaultNy
			,ifmeDelNy
		) values (
			#{ifmmSeq} 
			,#{ifmeEmailAccount}
			,#{ifmeEmailDomainCd}
			,concat(#{ifmeEmailAccount}, "@", (select ifcdName from infrCode where #{ifmeEmailDomainCd} = ifcdSeq))
			,1
			,0
		)
	</insert>
	
	<insert id="insertInfrMemberJoinQna">
		insert into infrMemberJoinQna(
			ifmmSeq
			,ifjqQuestionCd
			,ifjqAnswer
			,ifjqDelNy
		) values (
			#{ifmmSeq}
			,#{ifjqQuestionCd}
			,#{ifjqAnswer}
			,0
		)
	</insert>
	
	<insert id="insertInfrMemberAddressOnline">
		insert into infrMemberAddressOnline(
			ifmmSeq
			,ifaoSnsTypeCd
			,ifaoUrl
			,ifaoDefaultNy
			,ifaoDelNy
		) values (
			#{ifmmSeq}
			,#{ifaoSnsTypeCd}
			,#{ifaoUrl}
			,1
			,0
		)
	</insert>
	
	<insert id="insertInfrMemberHobby">
		insert into infrMemberHobby( 
			ifmmSeq
			,ifmhHobbyCd
			,ifmhUseNy
			,ifmaDelNy
		) values (
			#{ifmmSeq}
			,#{ifmhHobbyCd}
			,1
			,0
		)
	</insert>
	
	<update id="updateMember">
		UPDATE
			infrMember
		SET 
			ifcdName = #{ifcdName}
		WHERE 1=1
			AND ifmmSeq = #{ifmmSeq}
	</update>
</mapper>